---
- name: Provision instance
  hosts: local
  connection: local
  gather_facts: True

  tasks:
    - name: Make sure that files/ssh-keys directory exists
      file:
        path: "{{ temp_folder }}"
        state: directory

    - name: Create an SSH key pair
      ec2_key:
        name: "{{ key_pair_name }}"
        region: "{{ ec2_region }}"
        wait: True
      register: key_pair

    - name: Dump key pair
      copy:
        content: "{{ key_pair.key.private_key }}"
        dest: "{{ key_pair_file }}"
        mode: 0600

    - name: Create temporary VPC
      ec2_vpc_net:
        name: "{{ placeholder }}"
        state: present
        cidr_block: 10.0.0.0/16
        resource_tags:
          Type: VyOS
          Name: "{{ placeholder }}"
        region: "{{ ec2_region }}"
      register: vpc

    - name: Create VPC Subnet
      ec2_vpc_subnet:
        state: present
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: 10.0.0.0/24
        resource_tags:
          Type: VyOS
          Name: "{{ placeholder }}"
      register: vpc_subnet
    
    - name: Create VPC Internet Gateway
      ec2_vpc_igw:
        state: present
        vpc_id: "{{ vpc.vpc.id }}"
        resource_tags:
          Type: VyOS
          Name: "{{ placeholder }}"
      register: vpc_igw
        
    - name: Create VPC Route Table
      ec2_vpc_route_table:
        state: present
        vpc_id: "{{ vpc.vpc.id }}"
        subnets: "{{ vpc_subnet.subnet.id }}"
        resource_tags:
          Type: VyOS
          Name: "{{ placeholder }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ vpc_igw.gateway_id }}"
      register: vpc_rtb

    # Update the default security group to allow SSH from anywhere
    - name: Update default security group
      ec2_group:
        name: default
        region: "{{ ec2_region }}"
        vpc_id: "{{ vpc.vpc.id }}"
        rules:
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: 0.0.0.0/0

    # Look up the AMI id to use based on a search
    - name: Look up Ubuntu Precise AMI ID
      ec2_ami_find:
        architecture: x86_64
        region: "{{ ec2_region }}"
        owner: 099720109477
        name: "ubuntu/images/hvm/{{ ubuntu_version }}-amd64-server-*"
        sort: name
        sort_order: descending
        sort_end: 1
      register: ami_id

    # ---- Launch EC2 instance ----
    - name: Launch an EC2 instance
      ec2:
        key_name: "{{ key_pair_name }}"
        assign_public_ip: True
        image: "{{ ami_id.results[0].ami_id }}"
        instance_type: "{{ instance_type }}"
        region: "{{ ec2_region }}"
        vpc_subnet_id: "{{ vpc_subnet.subnet.id }}"
        wait: yes
        instance_tags:
          Name: "{{ placeholder }}"
          Type: "VyOS"
        volumes:
          - device_name: /dev/sdf
            volume_type: gp2
            volume_size: "{{ volume_size }}"
            delete_on_termination: True
      register: ec2_instance

    - name: Add instance's public DNS name to ansible host group ec2
      add_host:
        name: "{{ ec2_instance.instances[0].public_ip }}"
        groups: ec2

    - debug: msg="{{ ec2_instance.instances[0].public_ip }}"

    - name: Wait for instance's SSH port to open
      wait_for:
        host: "{{ ec2_instance.instances[0].public_ip }}"
        port: 22
        delay: 10
        state: started
